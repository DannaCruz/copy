# Análisis cuantitativo de texto {#qta}

*Por Sebastián Huneeus*

***

**Lecturas de referencia**

- Calvo, E., & Aruguete, N. (2018). #Tarifazo. Medios tradicionales y fusión de agenda en redes sociales. En *Inmediaciones de la Comunicación, 13*(1), 189–213. 

- Calvo, E., Dunford, E., & Lund, N. (2016). Hashtags that Matter: Measuring the propagation of Tweets in the Dilma Crisis. [Working Paper](https://www.researchgate.net/profile/Ernesto_Calvo/publication/306275910_Hashtags_that_Matter_Measuring_the_propagation_of_Tweets_in_the_Dilma_Crisis/links/57b732b408aec9984ff2a21f/Hashtags-that-Matter-Measuring-the-propagation-of-Tweets-in-the-Dilma-Crisis.pdf).

- Jelani Ince, Fabio Rojas & Clayton A. Davis (2017). The social media response to Black Lives Matter: how Twitter users interact with Black Lives Matter through hashtag use.* Ethnic and Racial Studies, 40*:11, 1814-1830.

- Salganik, Matthew J. (2017). *Bit by Bit: Social Research in the Digital Age*. Princeton, NJ: Princeton University Press.

- Steinert-Threlkeld, Z. (2018). *Twitter as Data (Elements in Quantitative and Computational Methods for the Social Sciences)*. Cambridge: Cambridge University Press. 

- Trott, Verity. (2018) Connected feminists: foregrounding the interpersonal in connective action, *Australian Journal of Political Science, 53*:1, 116-129.

***

## Introducción 

Twitter, Facebook y otras redes sociales se han convertido en una fuente de datos políticos de enorme valor. Por ejemplo, #olafeminista, #metoo, #blacklivesmatter o #niunasmenos son *hashtags* de temáticas políticas que han inundado las comunicaciones en Twitter en el último tiempo. Un *hashtag* (expresado con el símbolo ‘#’) es un texto que conecta a varias cuentas de Twitter a través de un tema. Son conexiones entre nodos y aglutina cuentas individuales, lo que es sumamente útil para entender la dinámica de la propagación de la protestas online y examinar cómo se desarrollan en el tiempo y en el espacio. Recientemente, ha emergido una literatura que aborda las protestas sociales y la defensa de derechos a través de la propagación de *hashtags*. En este contexto hay trabajos recientes que abordan [reclamos feministas](https://www.tandfonline.com/doi/abs/10.1080/10361146.2017.1416583) o [formas de activismo racial](https://www.tandfonline.com/doi/abs/10.1080/01419870.2017.1334931) en Twitter.

En este capítulo vamos a aplicar estadística descriptiva para abordar el uso de *hashtags* en la #olafeminista como ejemplo de cómo podemos usar redes sociales para tratar nuestros temas de investigación. La pregunta que dio origen a este análisis fue ¿qué patrones se observan en la manera con que los diputados chilenos usan los *hashtags* en la protesta social #olafeminista? Se trata de una pregunta exploratoria y no explicativa. El tema de fondo que nos interesa abordar es que en redes sociales, usar un *hashtag* en general equivale a estar interesado sobre un tema - independientemente de si se está a favor o en contra de cierto tema. En cierta forma, podríamos argumentar, los *hashtags* son proxis de la visibilidad de ciertos temas políticos. 

Este ejercicio que haremos es un excelente paso previo al análisis cualitativo en profundidad, por ejemplo mediante entrevistas, ya que los *hashtags* pueden servirnos para identificar a qué políticos están favor, en contra o simplemente no les interesa cierto tema. Así mismo, sirve para identificar a diputados que tienen como prioridad de su agenda política las temáticas de género y comprender de qué forma se vinculan con su electorado a partir de este tema. En términos metodológicos, con este ejercicio vamos a aproximarnos a cómo las coaliciones legislativas y diputados individuales usan *hashtags* de género y/o feminismo. Los paquetes de `R` utilizados serán `tidyverse`, `wordcloud2`, `skimr` y `lubridate`. De estos cuatro, al menos `tidyverse` y `skimr` deberían serte familiares a esta altura del libro. 

La unidad de análisis para este ejercicio serán los 155 diputados chilenos, y el período de recolección de datos abarcó entre el 1 de mayo y el 10 de junio de 2018. En total, 131 de 155 diputados escribieron al menos un tweet durante ese período, que coincidió con el auge de la ola feminista. La búsqueda en [Google Trends]( https://trends.google.es/trends/explore?date=today%205-y&geo=CL&q=acoso,feminismo) de los términos “acoso” y “feminismo” en Chile muestra que durante el rango de fechas que hemos seleccionado corresponde al de mayor interés entre 2014 y 2019, como se ve entre las líneas punteadas que marcan el inicio y fin de nuestra recolección de datos. 

```{r pref-gtrends, echo=FALSE, message=F, fig.cap="Interés en Chile por la #olafeminista", out.width='70%'}
library(tidyverse)
gtrends_feminismo <- read_csv("00-datos/qta/gtrends.csv")
estudio <- data.frame(
  fecha  = as.Date(c("1-5-2018", "10-6-2018"), "%d-%m-%Y"), 
  evento = c("inicio de estudio", "fin de estudio")
  )
ggplot(gtrends_feminismo, 
       aes(x = as.Date(semana, "%d-%m-%Y"), y = interes, color = termino)) +
  geom_line() + 
  geom_vline(data    = estudio,
             mapping = aes(xintercept = fecha), 
             color   = "black", linetype = "dotted") 
rm(gtrends_feminismo)
```
Existen varios mecanismos para recolectar datos desde Twitter y transformarlos en variables. El primer método, que quisiéramos evitar es el que podríamos llamar de “fuerza bruta”, es decir recolectar los tweets uno a uno, de manera manual. La segunda alternativa es a través de una API (del inglés *application programming interface*). Por medio de una API gratuita podemos bajar tweets de manera automatizada. Para acceder a la API de Twitter recomendamos usar los paquetes `twitteR` o `rtweet`. Crendo una cuenta de developer podemos ingresar a Twitter a través de esta plataforma. A *grosso modo* hay dos alternativas de usar la API para bajar tweets. (a) Para un *hashtag* en particular (por ejemplo ‘#Trump’) se pueden bajar hasta 18 mil tweets de hasta ocho días de antigüedad, que serán obtenidos del conjunto de tweets que hayan usado este *hashtag* de manera aleatoria. Si nuestro tema de interés supera el número de 18 mil tweets, podemos iterar la función para ampliar la muestra. En una hora se pueden bajar hasta 54 mil tweets. Si quieres hacer un seguimiento de un fenómeno de más de ocho días de antigüedad vas a tener que buscar alternativas pagas, que son muy costosas ¡Es importante estar alerta para empezar a recolectar datos antes de que sea tarde! (b) Cuando quieres hacer un seguimiento de un usuario en particular, la extracción te permite seguir una cuenta y de esa cuenta bajar una determinada fija de los tweets (hasta 3200) que haya publicado esta cuenta. Para más información de cómo utilizar esta herramienta puedes ir al capítulo \@ref(web-mining) sobre *web scrapping*. 

Para el análisis usaremos una base de datos lista, con variables de identificación de diputados, tweets y *hashtags*. Las variables de identificación de los diputados se extrajeron fácilmente de la [Página oficial de la Cámara de Diputados](https://www.camara.cl/camara/diputados.aspx#tab). Para hacer la extracción de datos de Twitter, utilizamos el paquete `Rtweet`, y así accedimos de manera gratuita al API de Twitter para [descargar información por usuarios, fechas y *hashtags*](https://www.earthdatascience.org/courses/earth-analytics/get-data-using-apis/use-twitter-api-r/). Para extraer datos de Twitter con `R` se recomienda leer [Twitter as Data](https://www.cambridge.org/core/elements/twitter-as-data/27B3DE20C22E12E162BFB173C5EB2592), que contiene algunas rutinas estandarizadas para descargar datos de esta plataforma. La base final tiene 15 variables y 9758 observaciones: tiene tantas observaciones como veces cada diputado usó cualquier *hashtag* en cualquiera de sus tweets y retweets. En esta base, por tanto, están incorporados solamente los tweets que usaron algún *hashtag* y se excluyeron todos los mensajes que no ocuparon algún *hashtag* durante ese período. 

## Exploración de la bases de datos 

Cargamos la base de datos y la exploramos con el paquete `skimr` para tener una imagen rápida del tamaño de la base, su número de observaciones y variables, así como el tipo de variables (*carácter*, *integer*, etc.).   

```{r message=F}
library(tidyverse)
library(skimr)
library(paqueteadp)
```

```{r}
data(tweets_dips_chile)
```

Ahora la base se ha cargado en nuestra sesión de `R`:

```{r}
ls()
```

`skimr` también nos entrega información sobre el número de datos perdidos (`missings`), la cantidad de categorías o valores que toma la variable de factor (`n_unique`), así como estadísticos de dispersión para las variables cuantitativas (valores mínimos y máximos, cuartiles, media y desviación estándar). Esto nos permite hacer un diagnóstico rápido sobre los datos con los que vamos a trabajar: vemos que hay once variables de tipo "character" (variables con texto), una de tipo "date" (variables con fechas), dos de tipo "factor" (variables categóricas) y una de tipo "POSIXct" que permite trabajar con fechas. La variable que contiene los *hashtags* de interés es la variable del mismo nombre, con `skimr` vemos que no hay valores perdidos, que tiene 9758 observaciones, siendo el más corto de ellos uno con 2 caracteres y el más largo con 54. Por último, vemos que en total se usaron 2309 *hashtags* únicos. Construir esta variable fue bastante sencillo, en la medida que el API separa, en una variable distinta, los mensajes de los *hashtags*. A través del paquete `stringr` para operar con expresiones regulares, separamos los *hashtags* cuando en un mensaje había más de uno y además hicimos una limpieza, quitando espacios, acentos y mayúsculas. 

```{r, message=F}
skim(tweets_dips_chile)
```
Podemos observar los primeros valores de la variable `hashtags` simplemente seleccionando dichas variables en la base:

```{r, message=F}
tweets_dips_chile %>% select(hashtags)
```
¡Ahora vamos a empezar el análisis de frecuencias de nuestra información!

## Cálculo de frecuencias

### ¿Cuáles son los diez hashtags más usados de las cuentas de los diputados? 

Si nos interesa saber es cuáles son los *hashtags* más usados usaremos `count()` para ver la frecuencia y luego `arrange(-n)` para ordenar el conteo de mayor a menor (nota que si quitamos el “–“ delante de la n el ordenamiento es de menor a mayor). Agregando los comandos `as.tibble()`y `dplyr::slice()`, generamos una tabla en la que solamente se muestra una cantidad acotada de valores, en este caso, los veinte mayores. Verás que el *hashtag* más usado es #cuentapublica, asociado a la rendición de cuentas presidencial del 21 de mayo en el que el presidente Sebastián Piñera se dirigió al Congreso Nacional. El *hashtag* #aborto3causales se ubica en quinto lugar, con 122 menciones en total. Éste hace referencia al [debate](ttps://ciperchile.cl/2018/09/04/todos-los-obstaculos-y-presiones-que-impiden-a-las-mujeres-acceder-al-aborto-por-tres-causales/) que se dio en Chile respecto a la legalización del aborto en caso de riesgo de la madre, inviabilidad fetal o violación a partir de la sanción de la ley 21030. En la doceava posición se ubica #interpelacionaborto3causales que remite a la [interpelación al ministro de Salud]( https://www.latercera.com/politica/noticia/las-claves-la-interpelacion-ministro-santelices/150705/), Emilio Santelices  sobre las modificaciones al protocolo de objeción de conciencia en el marco de la ley de aborto en tres causales. Además, en la posición decimosexta se ubica el *hashtag* #olafeminista.   

```{r results = "markup"}

tweets_dips_chile %>% 
  count(hashtags) %>% 
  arrange(-n) %>% 
  dplyr::slice(1:20)

```

También creamos una tabla en que las frecuencias *hashtags* están separadas por la variable de género `dummy_mujer`. De esta forma, podemos ver de manera rápida si hay diferencias claras en la frecuencia de tweets por género del diputado.

```{r results = "markup"}
tweets_dips_chile %>% 
  group_by(dummy_mujer) %>% 
  count(hashtags) %>% 
  arrange(hashtags)
```
Analicemos más en profundidad las diferencias por género.

### Frecuencias por género: cantidad de hashtags usados por los diputados en total

Las funciones `group_by()` y `summarise()` nos permiten contar el número de observaciones asociados a una variable de base. Al hacer un conteo de los valores `0` (hombre) y `1` (mujer) de `dummy_mujer`, sabremos cuantas veces cada género ocupó algun*hashtag* al escribir un tweet. Vemos que los hombres ocuparon un *hashtag* 6169 veces, mientras que las mujeres 3589 veces. 
```{r}
tweets_dips_chile %>% 
  group_by(dummy_mujer) %>% 
  summarise(total = n())
```
Ahora, podríamos ver cuáles son los principales 20 *hashtags* entre mujeres:
```{r results = "markup"}
tweets_dips_chile %>% 
  filter(dummy_mujer==1) %>% 
  count(hashtags) %>% 
  arrange(-n) %>% 
  slice(1:20)
```
Y entre hombres:
```{r results = "markup"}
tweets_dips_chile %>% 
  filter(dummy_mujer==0) %>% 
  count(hashtags) %>% 
  arrange(-n) %>% 
  slice(1:20)
```
Entre las mujeres contamos 45 referencias a #aborto3causales y 122 entre los hombres, una relación de 1 a 3. Sin embargo, son muchas menos las legisladoras mujeres, lo que puede explicar esta diferencia. Si controlamos por esta variable, vemos que la probabilidad de usar el *hashtag* #aborto3causales es virtualmente la misma entre hombres y mujeres. 
```{r}
library(sjPlot)

tweets_dips_chile <- mutate(tweets_dips_chile, a3c=ifelse(hashtags == "aborto3causales",1,0))

probabilidad <- glm(a3c~dummy_mujer + as.factor(diputado), 
                data   = tweets_dips_chile,
                family = binomial("logit"))

# plot_model(probabilidad, 
#            type = "pred",
#            show.ci = TRUE,
#            terms  = "dummy_mujer")
```
## Wordcloud de hashtags

La nube de palabras permite generar una representación visualmente amena de las frecuencias, ubicando al centro y más grandes los casos que tiene una mayor frecuencia. Para ello cargamos `wordcloud2` y lo aplicamos sobre el conteo de cada *hashtag*. 

```{r, fig.cap="Nube de palabras con `wordcloud2`", out.width='110%'}
library(wordcloud2)
wordcloud2(tweets_dips_chile %>% count(hashtags) %>% arrange(-n)) 
```
Si vas a usar esta nube para un poster académico podés darle la forma, por ejemplo, del pajarito de Twitter para hacerlo más atractivo a la audiencia. 
```{r, fig.cap="Nube de palabras con forma personalizada", out.width='110%'}
library(wordcloud2)
wordcloud2(tweets_dips_chile %>% count(hashtags) %>% arrange(-n), figPath = "00-images/twitter_logo.jpg") 
```
Agregando un filtro sobre la variable `dummy_mujer` podemos generar nubes diferencindo entre diputadas y diputados. Con esto se aprecia inmediatamente que los *hashtags* como #olafeminista, #agendamujer y #educacionnosexista aparecen con mucha mayor frecuencia entre diputadas que entre los diputados. 

```{r, fig.cap="Nube de palabras con `wordcloud2` divididas por género", out.width='110%'}
wordcloud2(tweets_dips_chile %>% filter(dummy_mujer == 1) %>%  count(hashtags) %>% arrange(-n)) 
wordcloud2(tweets_dips_chile %>% filter(dummy_mujer == 0) %>%  count(hashtags) %>% arrange(-n)) 

```

## Graficar los hashtags más utilizados por grupos de interés

### Hashtags más usados entre las diputadas

Usaremos `ggplot2` para graficar estas frecuencias ordenándolas de mayor a menor a través de `fct_reorder()`. Vamos a generar este gráfico en dos pasos, primero creando una nueva tabla con los diez *hashtags* más utilizados por las mujeres; en esta tabla solamente habrán dos variables, una con el nombre del *hashtag* y la segunda con su frecuencia `n`.  Luego, haremos un gráfico de columnas agregando el argumento `geom_col()` a la función `ggplot`. Al filtrar por género y considerar solamente a las diputadas mujeres, los *hashtags* #aborto3causales se ubica en tercer lugar, así como #olafeminista que se ubica en el octavo lugar y #agendamujer en el décimo lugar. 

```{r, fig.cap="Hashtags más comunes en las cuentas de Twitter de las diputadas", out.width='80%'}
plot_10_mujeres <- tweets_dips_chile %>% filter(dummy_mujer == 1) %>% 
  count(hashtags) %>% 
  arrange(-n) %>% 
  dplyr::slice(1:10) 

ggplot(data    = plot_10_mujeres,
       mapping = aes(x = fct_reorder(hashtags, n), y = n)) +
  geom_col (width =0.1) +
  coord_flip() +
  labs(x        = "", 
       y        = "Menciones",
       subtitle = "1 mayo - 10 de junio",
       caption  = "Fuente: Elaboración propia")
```

### Hashtags más usados entre los diputados

Al filtrar por género y considerar solamente a los diputados hombres, los *hashtags* #aborto3causales, #olafeminista y #agendamujer desaparecen del ranking. Esto entrega señales para posteriores preguntas empíricas, por ejemplo, sobre las motivaciones que tienen los diputados para posicionarse a temas de género.

```{r,  fig.cap="Hashtags más comunes en las cuentas de Twitter de los diputados", out.width='80%'}
plot_10_hombres <- tweets_dips_chile %>% filter(dummy_mujer == 0) %>% 
  count(hashtags) %>% 
  arrange(-n) %>% 
  dplyr::slice(1:10)

ggplot(data    = plot_10_hombres,
       mapping = aes(x = fct_reorder(hashtags, n), y = n)) +
  geom_col(width = 0.1) +
  coord_flip() +
  labs(x        = "", 
       y        = "Menciones",
       subtitle = "1 mayo - 10 de junio",
       caption  = "Fuente: Elaboración propia")
```

## Hashtags de género por características del diputado 

### Por el género del diputado

Contamos la frecuencia con que las diputadas usan algunos de los *hashtags* más emblemáticos de la ola feminista. Para ello aplicamos dos filtros, uno sobre la variable `hashtags` y otro sobre `dummy_mujer`. A esto se le agrega la función `count()` que permite contar frecuencias. 

```{r }
tweets_dips_chile %>%
  filter(hashtags %in% c("olafeminista",
                         "agendamujer", 
                         "interpelacionaborto3causales", 
                         "educacionnosexista") & 
           dummy_mujer == 1) %>%
  count(hashtags) %>% 
  arrange(-n)
```
Luego, contamos la frecuencia con que los diputados hombres usan algunos de los *hashtags* más emblemáticos de la ola feminista: 

```{r }
tweets_dips_chile %>%
  filter(hashtags %in% c("olafeminista",
                         "agendamujer", 
                         "interpelacionaborto3causales", 
                         "educacionnosexista") & 
           dummy_mujer == 0) %>%
  count(hashtags) %>% 
  arrange(-n)
```

Solamente contando frecuencias y comparando a hombres y mujeres, vemos que existen diferencias notorias. Por ejemplo, las diputadas usaron #olafeminista 53 veces, mientras que los diputados solamente 14 veces. Posteriormente, se podría ver qué tan significativa es esta diferencia a través de un test de comparación de proporciones con `prop.test` o a partir de una regresión como ya ejemplificamos anteriormente para #aborto3causales.

### Por la coalición de los diputados

Ahora vamos a examinar la frecuencia con que cada coalición emplea el hashtag #olafeminista, uno de los más emblemáticos de la movilización.A nivel de coaliciones, vemos que el hashtag #olafeminista es mencionado por La Fuerza de la Mayoría (LFM) y Frente Amplio (FA). La coalición de derecha, Chile Vamos (ChV) y Convergencia Democrática (CODE) no ocuparon este hashtag durante período analizado. Este dato puede servir para explorar el posicionamiento de los políticos de centro y de derecha en temas como el avance en la igualación de los derechos de las mujeres. 

Primero vemos la cantidad de veces que una coalición ocupó algún hashtag. 
```{r include = F}
tweets_dips_chile %>% group_by(coalicion) %>% count(coalicion) %>% arrange(-n)
```

####  Chile Vamos
```{r}
tweets_dips_chile %>%
  filter(hashtags== "olafeminista" & coalicion == "ChV") %>%
  count(hashtags) 
```

#### La Fuerza de la Mayoría 
```{r}
tweets_dips_chile %>%
  filter(hashtags== "olafeminista" & coalicion == "LFM") %>%
  count(hashtags)
```

#### Frente Amplio
```{r echo = F}
tweets_dips_chile %>%
  filter(hashtags== "olafeminista" & coalicion == "FA") %>%
  count(hashtags) 
```

####  Convergencia Democrática
```{r echo = F}
tweets_dips_chile %>%
  filter(hashtags== "olafeminista" & coalicion == "CODE") %>%
  count(hashtags) 
```

```{r include = F}
library(lubridate)

palabras_semana <- tweets_dips_chile %>%
  mutate(semana = floor_date(created_at, "week")) %>% 
  group_by(semana) %>%
  summarise(n_semana = n())

palabras_semana 
```
```{r echo = F}
  agendamujer_semana <- tweets_dips_chile %>%
  filter(hashtags == "olafeminista") %>%
  mutate(semana = floor_date(created_at, "week")) %>% 
  group_by(semana) %>%
  summarise(agendamujer_semana = n())
  
agendamujer_semana 
```
floor_date
Ahora tomando una tríada de hashtags feministas y/o que hacen referencia a temas de género, constatamos que la coalición Convergencia Democrática (CODE) desaparece totalmente de la conversación. Es decir, que la coalición de centro, integrada por la Democracia Cristiana, no ocupó los tres hashtags durante el período analizado. 

####  Chile Vamos
```{r echo = F}
tweets_dips_chile %>%
  filter(hashtags %in% c("agendamujer", "interpelacionaborto3causales", "educacionnosexista") & coalicion == "ChV") %>%
  count(hashtags) 
```
 
```{r echo = F}  
    hashtags_interesantes_semana <- tweets_dips_chile %>%
    filter(hashtags %in% c("agendamujer", "olafeminista",  "educacionnosexista")) %>%
    mutate(semana= floor_date(created_at, "week")) %>% 
    group_by(semana, hashtags) %>%
    summarise(hashtags_por_semana = n()) 
hashtags_interesantes_semana
```



```{r echo = F}
# ggplot(data    = hashtags_interesantes_semana,
#        mapping = aes(x = semana, y = hashtags_por_semana, color = hashtags)) +
#   geom_point(size = 3) +
#   geom_line(size = 1) +
#   scale_color_brewer(palette = "Set2") + 
#   labs(x         = "Semana", 
#        y        = "Menciones semanales",
#        title    = "Hashtags de género en las cuentas de Twitter de los diputados",
#        subtitle = "1 mayo - 10 de junio",
#        caption  = "Fuente: Elaboración propia")
# 
# palabras_semana <- tweets_dips_chile %>%
#   mutate(semana = floor_date(created_at, "week")) %>% 
#   group_by(semana) %>%
#   summarise(n_semana = n())
# 
# palabras_semana 
```


```{r, echo = F}      
porc_hashtags_interesantes_semana <- left_join(palabras_semana, hashtags_interesantes_semana) %>%
        mutate(porc_hash_sem = (hashtags_por_semana / n_semana) * 100)      
```

    

####  La Fuerza de la Mayoría 
```{r echo = F}
tweets_dips_chile %>%
  filter(hashtags %in% c("agendamujer", "interpelacionaborto3causales", "educacionnosexista") & coalicion == "LFM") %>%
  count(hashtags) 
```

####  Frente Amplio 
```{r echo = F}
tweets_dips_chile %>%
  filter(hashtags %in% c("agendamujer", "interpelacionaborto3causales", "educacionnosexista") & coalicion == "FA") %>%
  count(hashtags) 
```

####  Convergencia Democrática 
```{r echo = F}
tweets_dips_chile %>%
  filter(hashtags %in% c("agendamujer", "interpelacionaborto3causales", "educacionnosexista") & coalicion == "CODE") %>%
  count(hashtags) 
```


## Variación temporal del uso de estos hashtags 

Para examinar la frecuencia semanal de cada hashtag por cada una de las coaliciones utilizamos el paquete `lubridate` que opera con datos en formato de fechas, por ejemplo, variables tipo "date" o "POSIXct". En nuestra base tenemos dos variables de ese tipo: "fechanacimiento" y "created_at". La segunda nos va a servir para generar una nueva base, con una variable que es la cantidad de *hashtags* por semana, a partir de los comandos `mutate()` y `floor_date()`.Vemos que en la base hay un total de 7 semanas consecutivas, siendo la semana 5 de nuestro análisis, entre el 21 y 27 de mayo, la que concentra la mayor cantidad de tweets con *hashtags*. 


```{r include = F}
library(lubridate)

words_week <- tweets_dips_chile %>%
  mutate(week = floor_date(created_at, "week")) %>% 
  group_by(week) %>%
  summarise(n_week = n())

words_week
```

###  Frecuencia semanal de #olafeminista
Para examinar la frecuencia semanal con que se utiliza un determinado hashtag, simplemente agregamos un `filter()`. 

```{r echo = F}
  agendamujer_week <- tweets_dips_chile %>%
  filter(hashtags == "olafeminista") %>%
  mutate(week = floor_date(created_at, "week")) %>% 
  group_by(week) %>%
  summarise(agendamujer_week = n())
  
agendamujer_week
```

### Frecuencia semanal de tres hashtags de género 
Lo mismo si queremos calcular cuantas veces se dijeron tres *hashtags* en una misma semana. 
```{r echo = F}
    
    hashtags_interesantes_semana <- tweets_dips_chile %>%
    filter(hashtags %in% c("agendamujer", "olafeminista",  "educacionnosexista")) %>%
    mutate(week= floor_date(created_at, "week")) %>% 
    group_by(week, hashtags) %>%
    summarise(hashtags_por_semana = n()) 
hashtags_interesantes_semana
```


### Grafiquemos los hashtags de género por semana

A continuación graficaremos el peak del uso de *hashtags* de género, que se dio en la semana del 14-20 de mayo. Esto coincide con la antesala de la cuenta pública del 21 de mayo y con la marcha feminista del día 16 de mayo. Este gráfico se nutre de una tabla como la generada justo más arriba.    


```{r echo = F,  fig.cap="Hashtags de género en las cuentas de Twitter de los diputados", out.width='80%'}
ggplot(data    = hashtags_interesantes_semana,
       mapping = aes(x = week, y = hashtags_por_semana, color = hashtags)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set2") + 
  labs(x         = "Semana", 
       y        = "Menciones semanales",
       subtitle = "1 mayo - 10 de junio",
       caption  = "Fuente: Elaboración propia")
```

### Ponderamos en relación al total de hashtags por semana

Si queremos ponderar por el total de *hashtags* usados semanalmente, generamos una nueva variable con `mutate()`es es la razón entre *hashtags* de interés dividido por el total semana. 

```{r, echo = F}      
porc_hashtags_interesantes_semana <- left_join(words_week, hashtags_interesantes_semana) %>%
        mutate(porc_hash_sem = (hashtags_por_semana / n_week) * 100)      
```
    
### Grafiquemos los hashtags interesantes ponderados por el total semanal   
    
Observamos que #agendamujer y #olafeminista tienen su peak durante la semana del 21 de mayo, período que coincidió con [una marcha](http://www.eldesconcierto.cl/2018/05/17/video-mayo-feminista-el-emocionante-registro-de-la-marcha-contra-la-violencia-de-genero/) y con la [cuenta pública presidencial](https://www.gob.cl/cuenta-publica-2018/). 

```{r, echo = F, fig.cap="Hashtags de género en las cuentas de Twitter de los diputados (proporciones semanales)", out.width='80%'}

ggplot(data    = porc_hashtags_interesantes_semana,
       mapping = aes(x = week, y = porc_hash_sem, color = hashtags)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set2") +
  labs(x         = "Semana", 
       y        = "Menciones semanales (proporciones semanales)",
       subtitle = "1 mayo - 10 de junio",
       caption  = "Fuente: Elaboración propia")
```

### Diputadas

Para generar comparaciones, ahora hacemos el mismo ejercicio con las diputadas mujeres. Para ello agregamos un filtro a la variable "dummy_mujer", seleccionando el valor 1. 

#### Menciones de género por semana

```{r include = F}
words_week_mujer <- tweets_dips_chile %>%
  mutate(week = floor_date(created_at, "week")) %>% 
  group_by(week) %>%
  filter(dummy_mujer==1) %>% 
  summarise(n_week = n())
words_week_mujer


### agenda mujer por semana

agendamujer_week_mujer <- tweets_dips_chile %>%
  filter(dummy_mujer==1) %>% 
  filter(hashtags == "agendamujer") %>%
  mutate(week = floor_date(created_at, "week")) %>% 
  group_by(week) %>%
  summarise(agendamujer_week = n())
agendamujer_week_mujer


### hashtags interesantes por semana:

hashtags_interesantes_semana_mujer <- tweets_dips_chile %>%
  filter(hashtags %in% c("agendamujer", "olafeminista",  "educacionnosexista")) %>%
  filter(dummy_mujer==1) %>% 
  mutate(week= floor_date(created_at, "week")) %>% 
  group_by(week, hashtags) %>%
  summarise(hashtags_por_semana = n()) 

hashtags_interesantes_semana_mujer
```

#### Hashtags de interés por semana

Observamos que #agendamujer y #olafeminista tienen su peak durante la semana del 21 de mayo, período que coincidió con [una marcha](http://www.eldesconcierto.cl/2018/05/17/video-mayo-feminista-el-emocionante-registro-de-la-marcha-contra-la-violencia-de-genero/) 

```{r echo= F, fig.cap="Hashtags de género en las cuentas de Twitter de las diputadas (total semanal)", out.width='80%'}
### Grafiquemos los hashtags interesantes por semana:

ggplot(data    = hashtags_interesantes_semana_mujer,
       mapping = aes(x = week, y = hashtags_por_semana, color = hashtags)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set2") +
  labs(x         = "Semana", 
       y        = "Menciones semanalaes (total)",
       subtitle = "1 mayo - 10 de junio",
       caption  = "Fuente: Elaboración propia")
```

```{r include= F}

##Ponderamos en relación al total de hashtags semanales 

porc_hashtags_interesantes_semana_mujer <- left_join(words_week_mujer, hashtags_interesantes_semana_mujer) %>%
  mutate(porc_hash_sem = (hashtags_por_semana / n_week) * 100)      

```

#### Hashtags de género por semana a nivel de diputadas (ponderados por el total semanal)

Ahora el grafico está representando el total de *hashtags* de género, ponderados por el total de *hashtags* usados durante esa semana. Vemos que se mantiene la relación, ya que #agendamujer y #olafeminista siguen preponderando en la semana del 21 de mayo, pero el eje Y ahora representa porcentajes semanales, de modo que en la semana peak, de todos los *hashtags* usados por la diputadas, cerca del 5% fueron #agendamujer. 

```{r echo= F, fig.cap="Hashtags de género en las cuentas de Twitter de las diputadas (ponderación)", out.width='80%'}

ggplot(data    = porc_hashtags_interesantes_semana_mujer,
       mapping = aes(x = week, y = porc_hash_sem, color = hashtags)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set2") +
labs(x         = "Semana", 
     y        = "Hashtags de género semanales (ponderación)",
     subtitle = "1 mayo - 10 de junio",
     caption  = "Fuente: Elaboración propia")
```

#### Diputados

Repetimos elejercicio con los diputados hombres, Para ello agregamos un filtro a la variable "dummy_mujer", seleccionando el valor 0. 

#### Hashtags de género por semana
```{r include= F}
words_week_hombre <- tweets_dips_chile %>%
  mutate(week = floor_date(created_at, "week")) %>% 
  group_by(week) %>%
  filter(dummy_mujer==0) %>% 
  summarise(n_week = n())
words_week_hombre


### agenda hombre por semana

agendamujer_week_hombre <- tweets_dips_chile %>%
  filter(dummy_mujer==0) %>% 
  filter(hashtags == "agendamujer") %>%
  mutate(week = floor_date(created_at, "week")) %>% 
  group_by(week) %>%
  summarise(agendamujer_week = n())
agendamujer_week_hombre


### hashtags interesantes por semana:

hashtags_interesantes_semana_hombre <- tweets_dips_chile %>%
  filter(hashtags %in% c("agendamujer", "olafeminista",  "educacionnosexista")) %>%
  filter(dummy_mujer==0) %>% 
  mutate(week= floor_date(created_at, "week")) %>% 
  group_by(week, hashtags) %>%
  summarise(hashtags_por_semana = n()) 

hashtags_interesantes_semana_hombre
```

Al graficar la frecuencia de uso de *hashtags*, en la semana del 21 de mayo los diputados usaron #agendamujer 16 veces, pero no lo ocuparon en ninguna otra semana. En ese mismo período se da el peak de #olafeminista. 

```{r echo = F , fig.cap="Hashtags de género en las cuentas de Twitter de los diputados", out.width='80%'}
### Grafiquemos los hashtags interesantes por semana:

ggplot(data    = hashtags_interesantes_semana_hombre,
       mapping = aes(x = week, y =hashtags_por_semana, color = hashtags)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set2") +
labs(x         = "Semana", 
     y        = "Hashtags de género semanales",
     subtitle = "1 mayo - 10 de junio",
     caption  = "Fuente: Elaboración propia")


```

```{r include = F}
##Ponderamos en relación al total de hashtags / mes.

porc_hashtags_interesantes_semana_hombre <- left_join(words_week_hombre, hashtags_interesantes_semana_hombre) %>%
  mutate(porc_hash_sem = (hashtags_por_semana / n_week) * 100)      
```


## Hashtags de género por semana a nivel de diputados (ponderados por semana)
Al graficar la ponderación, los valores del eje Y representan porcentajes semanales. Vemos que #agendamujer es un poco más del 1% y #olafeminista cerca del 0,5%, en la semana del 21 de mayo.  

```{r echo = F, fig.cap="Hashtags de género en las cuentas de Twitter de los diputados (ponderación)", out.width='80%'}

ggplot(data    = porc_hashtags_interesantes_semana_hombre,
       mapping = aes(x = week, y = porc_hash_sem, color = hashtags)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set2") +
labs(x         = "Semana", 
     y        = "Hashtags de género semanales (ponderación)",
     subtitle = "1 mayo - 10 de junio",
     caption  = "Fuente: Elaboración propia")

```


## Comentarios finales 

Este ejercicio permite constatar varias diferencias en el uso de *hashtags* tanto a nivel de género de los diputados como de las coaliciones estudiadas. Respecto de la variación de género, las mujeres ocupan los *hashtags* relacionados con temas de género con mayor frecuencia, lo que fue particularmente evidente con #olafeminista y #agendamujer. Respecto de las coaliciones, el Frente Amplio y La Fuerza de la Mayoría (ex Nueva Mayoría) se posicionaron con mayor intensidad, ya que usaron *hashtags* de interés con mayor frecuencia, lo que queda patente nuevamente con #olafeminista. Al contrario, coaliciones como Convergencia Democrática desaparecen totalmente de la conversación si se filtra, por ejemplo, por #agendamujer. 

Respecto de la variación temporal, la mayor intensidad de las menciones a temas de género se dío en la semana del 14-20 de mayo, semana previa al discurso presidencial del 21 de mayo, que además coincidió con una marcha en varias ciudades del país. Vemos que en términos relativos, las diputadas mujeres están hasta cinco veces más interesadas en el movimiento feminista, esto ya que en la semana del 14-20 de mayo, las mujeres ocuparon #agendamujer 5 veces más que los hombres. 

¿Para qué hacer este ejercicio? Principalmente, puede servir como paso previo para un diseño de investigación descriptivo, que aborde los tipos de apoyo e intensidades de opiniones entorno al movimiento feminista y los temas de género. Por otra parte, también puede servir de punto de arranque para diseños explicativos que indaguen en las causas del posicionamiento de los políticos en temas de derechos de la mujer. La estrategia empleada puede servir como una forma de medir, indirectamente, el apoyo o interés que tienen los diputados sobre derechos de la mujer y temáticas de género. Para profundizar sobre el tipo de estrategias de investigación más comunes en ciencias sociales usando bigdata, se puede leer online este [capítulo del libro Bit by Bit de Matthew Salganik](https://www.bitbybitbook.com/en/1st-ed/observing-behavior/strategies/). 

En términos de destrezas necesarias, este ejercicio no requiere más que manejo básico de `tidyverse`. Posiblemente la parte más compleja sea la obtención y la estructuración de la base de datos. Afortunadamente, el API de Twitter y paquetes como `TwwiteR`o `Rtweet` permiten gestionar las descargas de información de manera sencilla y ordenada. Para una referencia completa sobre como como se han abordado y de cómo enfrentar preguntas de investigación de ciencias sociales en Twitter, más sugerencias técnicas sobre como descargar y procesar datos de esta plataforma, se recomienda ver el [libro Twitter as Data de Zachary Steinert-Threlkeld](https://www.cambridge.org/core/elements/twitter-as-data/27B3DE20C22E12E162BFB173C5EB2592). 

Por último, para profundizar sobre el movimiento feminista chileno durante el año 2018, se recomienda el libro editado por la periodista [Faride Zerán, Mayo feminista. La rebelión contra el patriarcado](https://lom.cl/0679a41b-1e5e-4045-87ae-39fba9e76acc/Mayo-feminista-La-rebeli%C3%B3n-contra-el-patriarcado.aspx) y para una referencia obligada sobre cómo una crisis política latinoamericana puede ser estudiada desde Twitter, el libro de [Ernesto Calvo, Anatomía Política de Twitter en Argentina](http://www.revistaanfibia.com/ensayo/la-grieta-en-tu-celular/) es un fluido y claro trabajo sobre la polarización desatada a raíz de la muerte del Fiscal Nisman. 

## Anexo: Problemas que se presentan cuando analizas discursos, debates o leyes

Es probable que quieras utilizar este aprendizaje para analizar otro tipo de textos, como pueden ser discursos, debates parlamentarios o cualquier otro texto mucho más extenso que un tweet. Si es así, entonces necesitarás hacer dos pasos que no cubrimos en el ejemplo anterior antes de proceder a analizar tus palabras. Primero necesitarás transformar los discursos en un data frame, y luego necesitarás eliminar “stop words”, es decir, palabras que quieres ignorar porque refieren a conectores (y, o, entonces), preposiciones (a, ante, bajo, etc) y artículos (nosotros, ellos). Usarás para esto el paquete `tidytext`. 

```{r, message=F}
library(tidytext)   
```

Para mostrarte cómo funciona vamos a usar datos del [archivo de Salvador Allende en marxists.org](https://www.marxists.org/espanol/allende/index.htm)  que contiene discursos públicos de Salvador Allende entre finales de 1969 y el 11 de septiembre de 1973. Los cargaremos, como antes, con la ayuda de `paqueteadp`, que debe estar cargado:

```{r}
data(discursos_allende)
```
La base tiene cuatro variables: el título del discurso, su fecha, el link del cual fue extraído, y finalmente el discurso entero. Cada observación es un discurso diferente. 
```{r}
glimpse(discursos_allende)
```
Vamos a eliminar discursos previos a 1970 y también vamos a unir algunas palabras. Por ejemplo, “Estados Unidos” pasará a ser “EstadosUnidos” ya que es un único concepto. Si no las unimos, “Unidos” será contada junto a expresiones como “el pueblo está unido en esta lucha” y perderemos calidad de nuestro análisis. Cuando trabajes con tus propios textos te recomendamos que sigas esta indicación.  

```{r}
discursos_allende <- discursos_allende %>%
  # colapsar nombres de países
  mutate(text_allende = str_replace_all(text_allende, "Estados Unidos", "EstadosUnidos"),
         text_allende = str_replace_all(text_allende, "Unión Soviética", "UniónSoviética"),
         text_allende = str_replace_all(text_allende, "Naciones Unidas", "NacionesUnidas")) %>%
  # solo del 70 en adelante. Para el 69 los archivos contienen solo el programa de la UP
  filter(fecha >= "1970-01-01")
```
Ahora que la base está lista, vamos a utilizar `tidytext` para dejarla lista para el análisis cuantitativo.

## `Tidy text`

En nuestra variable `text_allende` tenemos cada uno de los discursos del ex presidente chileno. Para poder analizarlos cuantitativamente debemos subdividirlos en unidades menores. Como el ejercicio consiste en hacer frecuencia de palabras más comunes, querremos dividir los discursos en palabras.  Para ello usaremos la función `unnest_tokens` con la opción `words`. Si quisieras dividir los discursos por oraciones puedes usar la opción `sentences` y si lo quieres por párrafos `paragraphs`.

```{r}
discursos_allende_tidy <- discursos_allende %>%
  unnest_tokens(word, text_allende)
```
¡Ahora en vez de tener 248 discursos, tenemos casi 1 millón de palabras bajo la variable `words`!
```{r}
discursos_allende_tidy
glimpse(discursos_allende_tidy)
```
Para eliminar los "stop words" necesitamos cargar el paquete `tm` e indicar el idioma de nuestro texto. ¡La lista es enorme!

```{r}
library(tm)
stopwords(kind = "es")
```
Saquémoslas de nuestra base. La nueva base `discursos_allende_tidy_limpia` tiene casi la mitad de observaciones que la base con “stop words”. Aunque no parezca, este paso es fundamental para que el análisis cuantitativo de texto salga bien. 

```{r}
discursos_allende_tidy_limpia <- discursos_allende_tidy %>%
  filter(!(word %in% stopwords(kind = "es"))) %>%
  # voy a aprovechar de sacar los dígitos / números:
  filter(!str_detect(word, "\\d"))
```
Ahora que tienes una base limpia, puedes hacer la rutina de análisis cuantitativo de texto de la igual manera que lo hicimos con los tweets de la #olafeminista. 



```{block, type="books"}
**Ejercicios antes de continuar al próximo capítulo**
- Trabajaremos con el debate presidencial argentino de 2015 entre Mauricio Macri y Daniel Scioli, por la segunda vuelta, que tuvo como ganador a Macri. La versión taquigráfica del debate fue publicada por el diario La Nación y puedes [abrirla acá.](http://www.lanacion.com.ar/1845904-transcripcion-completa-del-debate-presidencial-entre-macri-y-scioli).

- Importe dos archivos separados, uno para Daniel Scioli, y otro para Mauricio Macri.

- Analice las palabras más frecuentes para cada candidato, eliminando “stop words”. 

- Ahora importe el debate de la primera ronda, donde había más candidatos (http://www.lanacion.com.ar/1833848-transcripcion-completa-del-debate-presidencial). ¿Cuáles fueron los temas que estructuraron el debate?
```




